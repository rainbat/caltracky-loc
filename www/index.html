<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<link rel="stylesheet" href="css/careicons.css">
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome/css/font-awesome-admin.min.css">
<!--link rel="stylesheet" href="css/the-theme-base.min.css"-->
<!--link rel="stylesheet" href="css/bootstrap-material-design-0.3.0/css/material.min.css"-->

<script src="cordova.js"></script>
<script src="js/jquery.js"></script>
<script src="js/app.js"></script>
<script src="js/date.js"></script>
<script src="js/moment.js"></script>


<script type="text/javascript">
	$(document).on('mobileinit', function(){
		log("pageinit");
		$.mobile.defaultPageTransition = 'slide';
	});
</script>

<script src="js/jquery.mobile-1.4.5.js"></script>

</head>
<<body>

<!-- Start of first page -->
<div data-role="page" id="menu">

	<div data-role="header">
		<h1>Calendar Time Tracking</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<a class="ui-btn" id="today">Sync Today</a>
		<center><div id="cards"></div></center>
		<a href="#settings" class="ui-btn">Settings</a>
		<a class="ui-btn" id="options">Sync Options</a>
		<script>
			$('#options').on('click', function () {
         	
				var calOptions = window.plugins.calendar.getCalendarOptions();
	  			calOptions.calendarName = "Work";
	  			calOptions.calendarId = calOptionsIdWork;
			     
			     window.plugins.calendar.listCalendars(
			     	function(msg){
			     		msg.forEach(function(entry) {
			     			if ( entry.name == "Work" )  calOptionsIdWork = entry.id;
			     			if ( entry.name == "Track" ) calOptionsIdTrack = entry.id;
			     		});
			     		log( "calOptionsIdWork:" + calOptionsIdWork);
			     		log( "calOptionsIdTrack:" + calOptionsIdTrack);
			     	},
			     	function(msg){
			     		log("Error listCalendars");
			     	}
			     );


			     window.plugins.calendar.findEventWithOptions(
			     	
			     	"CalTracky Options", 
			     	null, 
			     	null, 
			     	
					new Date.parse("2018-01-01"),
					new Date.parse("2022-31-12"), 
			     	
			     	calOptions,

			     	function (msg) {

					    log('Calendar Found Options success: ' + msg.length);
						
						if( msg.length == 0){

				            window.plugins.calendar.createEventWithOptions(
      
			                  "CalTracky Options",
			                  "Home",
			                  "{ 'test' : 'test' }",
			                  
			                  new Date(),
			                  new Date( moment().add(1, 'hours') ),
			                  
			                  calOptions,
			                  
			                  function(msg) { log("Success createEventWithOptions: " + JSON.stringify(msg)); },
			                  function(msg) { log("Error createEventWithOptions: " + msg); }
			                
			                );


						}else{
							$("#cards").append( "Found Options " + msg[0].message);
						}

					}, 
			     	function(msg) { log("Error findEventWithOptions: " + msg); }
			     );

			});

			$('#today').on('click', function () {
         	
				window.plugins.calendar.listCalendars(
			     	function(msg){
			     		msg.forEach(function(entry) {
			     			if ( entry.name == "Work" )  calOptionsIdWork = entry.id;
			     			if ( entry.name == "Track" ) calOptionsIdTrack = entry.id;
			     		});
			     		log( "calOptionsIdWork:" + calOptionsIdWork);
			     		log( "calOptionsIdTrack:" + calOptionsIdTrack);
			     	},
			     	function(msg){
			     		log("Error listCalendars");
			     	}
			     );

				if( calOptionsIdWork == "" || calOptionsIdTrack == ""){
					$("#cards").append("<b>Calendars Work and Track not found.</b>");
				}

				var calOptions = window.plugins.calendar.getCalendarOptions();
	  			calOptions.calendarName = "Work";
	  			calOptions.calendarId = calOptionsIdWork;
			     
			     window.plugins.calendar.findEventWithOptions(
			     	
			     	null, 
			     	null, 
			     	null, 
			     	
					new Date.today(),
					new Date.today().addDays(1) , 
			     	
			     	calOptions,

			     	function (msg) {

					    log('Calendar success: ' );
						
						$("#cards").empty();

					    msg.forEach(function(entry) {
					   
					      var spart = entry.startDate.split(' ');
					      var epart =  entry.endDate.split(' ');
					   
					      tmp_card = addCard(entry.id, entry.title, spart[1], epart[1] );
					   
					      if( entry.title.indexOf("Options") == -1) $("#cards").append(tmp_card);
					   
					    });

					}, 
			     	function(msg) { log("Error findEventWithOptions: " + msg); }
			     );

			//});

			//$('#syncTrackStatus').on('click', function () {
		
				var calOptions = window.plugins.calendar.getCalendarOptions();
	  			calOptions.calendarName = "Track";
	  			calOptions.calendarId = calOptionsIdTrack;
			     
			     window.plugins.calendar.findEventWithOptions(
			     	
			     	null, 
			     	null, 
			     	null, 
			     	
					new Date.today(),
					new Date.today().addDays(1) , 
			     	
			     	calOptions,

			     	function (msg) {

					    log('Calendar success: ' );
						
						$("#track").empty();
					    $("#track").append("<table border=1>");
					    msg.forEach(function(entry) {
					    	
					    	var spart = entry.startDate.split(' ');
						    var epart = entry.endDate.split(' ');

					     	$("#track").append( "<tr><td>" + spart[1] + " " + epart[1] + " " + entry.title + "</td></tr>" );

					     	if(entry.title.indexOf("(Start Drive)") >=0){
					     		$("#" + entry.message + " > div > div > button[id=wt-drive]").prop("disabled", true);
								$("#" + entry.message + " > div > div > button[id=wt-drive] > i").removeClass();
								$("#" + entry.message + " > div > div > button[id=wt-drive] > i").addClass("fa fa-3x fa-refresh fa-spin");
					     	}

							if(entry.title.indexOf("(Start Work)") >=0){
					     		$("#" + entry.message + " > div > div > button[id=wt-work]").prop("disabled", true);
							    $("#" + entry.message + " > div > div > button[id=wt-work] > i").removeClass();
							    $("#" + entry.message + " > div > div > button[id=wt-work] > i").addClass("fa fa-3x fa-refresh fa-spin");
					     	}

							if(entry.title.indexOf("(Memo)") >=0){
							    //$("#" + entry.message + " > div > div > button[id=wt-note] > i").addClass("fa fa-3x fa-refresh fa-spin");
					     	}


						});
					   
					   $("#track").append("</table>");
					   

					}, 
			     	function(msg) { log("Error syncTrackStatus: " + msg); }
			     );

			});
		</script>
	</div><!-- /content -->

	<div data-role="footer" data-position="fixed">
		<h4>Page Footer</h4>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of second page -->
<div data-role="page" id="details">

	<div data-role="header">
		<a href="#menu" data-direction="reverse" class="ui-btn"><</a>
		<h1>Calendar Time Tracking</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<a id="saveMemo" class="ui-btn">Save</a>

		<div data-role="fieldcontain">
            <input type="text" id="title">
            <label for="textarea-3">Memo</label>
            <textarea id="memo" rows="15" name="textarea-13" id="textarea-3" class="editor" data-autogrow="false"></textarea>
        </div>
        
        <a href="#menu" class="ui-btn">Memos load</a>

		<script>
			$('#saveMemo').on('click', function () {
	
  				var filterOptions = window.plugins.calendar.getCalendarOptions(); 
				filterOptions.calendarName = "Track";
				filterOptions.calendarId = calOptionsIdTrack;
				
				var newOptions = window.plugins.calendar.getCalendarOptions(); 
				newOptions.calendarName = "Track";
				newOptions.calendarId = calOptionsIdTrack; 
				
				window.plugins.calendar.modifyEventWithOptions(

					$("#title").val() + " (Memo)",
					"Home",
					null,

					new Date.today(),
					new Date.today().addDays(1) , 

					$("#title").val() + " (Memo)",
					"Home",
					$("#memo").val(),

					new Date(),
			        new Date( moment().add(1, 'hours') ),

					filterOptions,
					newOptions,

				function(msg) { 
					log("Success modifyEventWithOptions: " + JSON.stringify(msg)); 
					$(':mobile-pagecontainer').pagecontainer('change', '#menu');
				},
				function(msg) { log("Error modifyEventWithOptions: " + msg); }

				);

  			});


        </script>

	</div><!-- /content -->

	<div data-role="footer" data-position="fixed">
		<h4>Page Footer</h4>
	</div><!-- /footer -->
</div><!-- /page -->


<!-- Start of fifth page -->
<div data-role="page" id="settings">

	<div data-role="header">
	<a href="#menu" data-direction="reverse" class="ui-btn"><</a>
		<h1>Settings</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		
		<!-- <a class="ui-btn" id="syncTrackStatus">syncTrackStatus</a> -->
		
		<br/>
		
		<a class="ui-btn" id="updateLog">updateLog</a>
		<div id="log" class="ui-shadow ui-listview-inset"></div>
		<div id="track" class="ui-shadow ui-listview-inset"></div>
		<br/>
		<a class="ui-btn" id="create">createEventNowStart</a>
		<a class="ui-btn" id="update">updateEventNowToEnd</a>
		<br/>
		<a class="ui-btn" id="location">getLocation</a>
		<a class="ui-btn" id="watchPosition">watchPosition</a>
		<a class="ui-btn" id="clearWatchPosition">clearWatchPosition</a>
		<br/>
		<a class="ui-btn" id="createFile">createFile</a>
		<a class="ui-btn" id="readFile">readFile</a>
		<a class="ui-btn" id="openFile">openFile</a>
		
	</div><!-- /content -->

	<script>

		$('#updateLog').on('click', function () {

			$("#log").empty();    

			$("#log").append("<table border=1>");

			var out = tmp.reverse();

			for( var i=0; i< out.length; i++){		
				$("#log").append( "<tr><td>" + out[i] + "</td></tr>" );
			}

			$("#log").append("</table>");


		});

		$('#create').on('click', function () {

			var calOptions = window.plugins.calendar.getCalendarOptions();
  			calOptions.calendarName = "Track";
  			calOptions.calendarId = calOptionsIdTrack;

  			window.plugins.calendar.createEventWithOptions(
				
				"My nice event (Start)",
				 "Home",
				"Some notes about this event.",
				
				new Date(),
				new Date( moment().add(1, 'hours') ),
				
				calOptions,
				
				function(msg) { log("Success createEventWithOptions: " + JSON.stringify(msg)); },
				function(msg) { log("Error createEventWithOptions: " + msg); }
			);

		});

		$('#update').on('click', function () {
		
			var calOptions = window.plugins.calendar.getCalendarOptions();
  			calOptions.calendarName = "Track";
  			calOptions.calendarId = calOptionsIdTrack;

			window.plugins.calendar.findEventWithOptions(
				
				"My nice event (Start)",
				"Home",
				"Some notes about this event.",
				
				new Date.today(),
				new Date.today().addDays(1) ,
				
				calOptions,

				function( msg ){

					var filterOptions = window.plugins.calendar.getCalendarOptions(); 
  					filterOptions.calendarName = "Track";
  					filterOptions.calendarId = calOptionsIdTrack;
  					var newOptions = window.plugins.calendar.getCalendarOptions(); 
  					newOptions.calendarName = "Track";
  					newOptions.calendarId = calOptionsIdTrack; 
  					
  					window.plugins.calendar.modifyEventWithOptions(

  						"My nice event (Start)",
						"Home",
						"Some notes about this event.",

  						Date.parse( msg[0].startDate ),
  						Date.parse( msg[0].endDate ),

  						"My nice event (End)",
						"Home",
						"Some notes about this event.",

  						Date.parse( msg[0].startDate ),
  						new Date(),

  						filterOptions,
  						newOptions,

						function(msg) { log("Success modifyEventWithOptions: " + JSON.stringify(msg)); },
						function(msg) { log("Error modifyEventWithOptions: " + msg); }

  					);

				},

				function(msg) { alert("Error modifyEventWithOptions: " + msg); }
			);
			
			

		});

		$('#location').on('click', function () {

			var onSuccess = function(position) {
				  log('Latitude: '          + position.coords.latitude          + '\n' +
				      'Longitude: '         + position.coords.longitude         + '\n' +
				      'Altitude: '          + position.coords.altitude          + '\n' +
				      'Accuracy: '          + position.coords.accuracy          + '\n' +
				      'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
				      'Heading: '           + position.coords.heading           + '\n' +
				      'Speed: '             + position.coords.speed             + '\n' +
				      'Timestamp: '         + position.timestamp                + '\n');
				};

			// onError Callback receives a PositionError object
			//
			function onError(error) {
			    log('code: '    + error.code    + '\n' +
			          'message: ' + error.message + '\n');
			}

			window.navigator.geolocation.getCurrentPosition(onSuccess, onError);

		});

		var watchID = "";

		$('#watchPosition').on('click', function () {

			// onSuccess Callback
			//   This method accepts a `Position` object, which contains
			//   the current GPS coordinates
			//
			function onSuccess(position) {
			    /*alert('Latitude: '          + position.coords.latitude          + '\n' +
				      'Longitude: '         + position.coords.longitude         + '\n' +
				      'Altitude: '          + position.coords.altitude          + '\n' +
				      'Accuracy: '          + position.coords.accuracy          + '\n' +
				      'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
				      'Heading: '           + position.coords.heading           + '\n' +
				      'Speed: '             + position.coords.speed             + '\n' +
				      'Timestamp: '         + position.timestamp                + '\n');*/
				log( "moving with :" + position.coords.speed );
			}

			// onError Callback receives a PositionError object
			//
			function onError(error) {
			    log('code: '    + error.code    + '\n' +
			          'message: ' + error.message + '\n');
			}

			// Options: throw an error if no update is received every 30 seconds.
			//
			var watchID = window.navigator.geolocation.watchPosition(onSuccess, onError, { timeout: 30000 });
			var watchID = window.navigator.geolocation.watchPosition(onSuccess, onError, { timeout: 30000 });
		
		});

		$('#clearWatchPosition').on('click', function () {
			window.navigator.geolocation.clearWatch(watchID);
		});

		$('#createFile').on('click', function () {

			window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fs) {

				console.log('file system open: ' + fs.name);
			    console.log('file system open: ' + fs.path);
			    
			    fs.root.getFile("newPersistentFile.txt", { 
			    	create: true, 
			    	exclusive: false 
			    	}, 
			    	function (fileEntry) {
			    		console.log("fileEntry is file?" + fileEntry.isFile.toString());

						fileEntry.createWriter(function (fileWriter) {

					        fileWriter.onwriteend = function() {
					            console.log("Successful file write...");
					        };

					        fileWriter.onerror = function (e) {
					            console.log("Failed file write: " + e.toString());
					        };

					        fileWriter.write(
					        	new Blob(['some file data'], { type: 'text/plain' } )
					        );

					    });

					    fileEntry.file(function (file) {
					        var reader = new FileReader();

					        reader.onloadend = function() {
					            console.log("Successful file read: " + this.result);
					            console.log(fileEntry.fullPath + ": " + this.result);
					        };

					        reader.readAsText(file);

					    }, 
					    function( msg ){
					    	console.log( msg );
					    });

			    	},
			    	function( msg ){
			    		log( msg );
			    });

			});

		});

		$('#readFile').on('click', function () {

			window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fs) {

				console.log('file system open: ' + fs.name);
			    console.log('file system open: ' + fs.path);
			    
			    fs.root.getFile("newPersistentFile.txt", { 
			    	create: true, 
			    	exclusive: false 
			    	}, 
			    	function (fileEntry) {
			    		console.log("fileEntry is file?" + fileEntry.isFile.toString());

						fileEntry.file(function (file) {
					    
					        var reader = new FileReader();

					        reader.onloadend = function() {
					            console.log("Successful file read: " + this.result);
					            console.log(fileEntry.fullPath + ": " + this.result);
					        };

					        reader.readAsText(file);

					    }, 
					    function( msg ){
					    	console.log( msg );
					    });

			    	},
			    	function( msg ){
			    		log( msg );
			    });

			});

		});


		$('#openFile').on('click', function () {
			cordova.plugins.fileOpener2.open(
			    'dvfile://localhost/persistent/newPersistentFile.txt',
			    'text/plain',
			    {
			        error : function(e) {
			            console.log('Error status: ' + e.status + ' - Error message: ' + e.message);
			        },
			        success : function () {
			            console.log('file opened successfully');
			        }
			    }
			);
		});

	</script>

	<div data-role="footer" data-position="fixed">
		<h4>Page Footer</h4>
	</div><!-- /footer -->
</div><!-- /page -->

</body>
</html>
